{% extends "base.html" %}
{% block title %}Register{% endblock %}
{% block content %}
  <h2>Register</h2>

  {% if error %}
    <p style="color:darkred">{{ error }}</p>
  {% endif %}

  {# Phase A: Create account #}
  {% if not qr_data_url %}
    <form method="post" autocomplete="off">
      <input name="username" placeholder="username" required />
      <input name="password" type="password" placeholder="password" required />
      <button type="submit">Register</button>
    </form>
    <p class="muted">Already have an account? <a href="{{ url_for('login') }}">Login</a></p>
  {% else %}
  {# Phase B: Show QR and confirm first TOTP code to enable 2FA #}
    <div class="card">
      <h3>Set up Two-Factor Authentication (TOTP)</h3>
      <p>Scan this QR in your authenticator app (Google Authenticator, Authy, etc.).</p>
      <img src="{{ qr_data_url }}" alt="TOTP QR code" style="max-width:220px;border:1px solid #ccc;padding:6px;border-radius:6px;">
      <p class="muted">Manual code (backup): <code>{{ totp_secret }}</code></p>

      <form method="post" style="margin-top:1rem;">
        <input type="hidden" name="username" value="{{ username }}">
        <input type="hidden" name="confirm_2fa" value="1">
        <input name="token" inputmode="numeric" pattern="[0-9]*" placeholder="Enter 6-digit code" required />
        <button type="submit">Enable 2FA</button>
      </form>

      <p class="muted" style="margin-top:.75rem;">
        Having issues? Ensure your phoneâ€™s time is synced; codes rotate every ~30s.
      </p>
    </div>
  {% endif %}
{% endblock %}
